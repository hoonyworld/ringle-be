# AI Tutor - Backend

## **개요**

-   AI 튜터의 모든 서버 측 로직 및 API를 제공하는 백엔드 시스템입니다.
-   Spring Boot 기반으로 구축되었으며, 사용자의 멤버십 관리, 실시간 AI 대화 중계, 외부 AI 서비스 연동 등 모든 서버 측 기능을 담당합니다.
-   실제 서비스를 가정하여 **도메인 주도 설계(DDD)** 와 **클린 아키텍처**를 적용했으며, 안정성, 확장성, 유지보수성을 최우선으로 고려하여 설계되었습니다.

## **핵심 기능**

### **What (무엇을)**

-   **유연한 B2B/B2C 멤버십 시스템:** 사용자의 역할(ADMIN, COMPANY, USER)에 따라 동적으로 다른 멤버십 플랜 정보를 제공하고, B2B 계약 및 사용자별 이용권을 관리하는 API 제공
-   **실시간 AI 대화 중계:** 사용자의 음성 입력을 텍스트로 변환(STT)하고, 외부 LLM의 답변을 실시간 스트리밍으로 클라이언트에 중계하는 대화 파이프라인 제공
-   **안전한 API 및 동시성 관리:** JWT 기반의 인증/인가를 통해 API를 보호하고, 동시성 이슈를 제어하여 데이터의 정합성을 보장

### **How (어떻게)**

-   **도메인 주도 및 계층형 아키텍처:** `Controller` → `UseCase` → `Service` → `Repository`로 책임을 명확히 분리했습니다. `User`, `Membership`, `Conversation` 등 핵심 도메인별로 패키지를 구성하여 높은 응집도와 낮은 결합도를 유지합니다.
-   **실시간 통신 및 비동기 처리 파이프라인:**
    -   **SSE 연결 관리:** Spring MVC의 `SseEmitter`를 사용하여 클라이언트별로 실시간 단방향 통신 채널을 수립하고, `ConcurrentHashMap`으로 다수의 연결을 스레드로부터 안전하게 관리합니다.
    -   **비동기 작업 위임:** STT 처리처럼 빠른 응답이 필요한 작업과 AI 답변 생성처럼 오래 걸리는 작업을 분리하기 위해 `@Async`를 사용합니다. STT 결과를 클라이언트에 즉시 반환한 뒤, 별도의 스레드에서 AI 작업을 비동기적으로 처리하여 사용자 경험을 저해하지 않도록 합니다.
    -   **외부 AI 연동:** `RestClient`를 사용하여 Google Cloud의 Speech-to-Text 및 Gemini API를 호출합니다. 특히, Gemini의 스트리밍 응답(JSON 배열)을 안정적으로 파싱하기 위해 저수준의 `JsonParser`를 직접 제어하여 데이터를 실시간으로 처리합니다.
-   **보안 및 데이터 정합성:**
    -   **인증/인가:** **Spring Security**를 통해 JWT 기반의 인증 시스템을 구축했습니다. `SecurityConfig`에서 `hasAuthority` 규칙을 사용하여 역할별 API 접근을 제어하고, `EventSource`의 제약을 해결하기 위해 URL 경로에 토큰을 포함하여 SSE 연결을 인증하는 방식을 구현했습니다.
    -   **동시성 제어:** 여러 사용자가 동시에 멤버십 횟수를 차감할 때 발생할 수 있는 데이터 불일치(race condition) 문제를 방지하기 위해, `UserMembershipRepository`의 조회 메서드에 **`@Lock(LockModeType.PESSIMISTIC_WRITE)`** (비관적 락)을 적용하여 데이터의 정합성을 보장합니다.

### **Why (왜)**

-   **성능 및 사용자 경험:**
    -   **비동기 SSE 푸시 아키텍처:** "STT 결과 즉시 반환 + AI 답변 백그라운드 생성 및 실시간 푸시" 구조를 채택하여, 사용자가 AI의 답변을 기다리는 동안 느끼는 **체감 지연 시간을 최소화**하고 실시간 타이핑 효과를 통해 생동감 있는 대화 경험을 제공합니다.
-   **안정성 및 데이터 무결성:**
    -   **비관적 락:** 금전적 가치가 있는 '멤버십 횟수'가 동시 요청으로 인해 중복 차감되는 심각한 비즈니스 로직 오류를 원천적으로 방지하기 위해 비관적 락을 채택했습니다.
    -   **비동기 보안 컨텍스트 전파:** `@Async` 스레드에서 인증 정보가 누락되어 발생하는 `Access Denied` 문제를 해결하기 위해 `DelegatingSecurityContextAsyncTaskExecutor`를 구성, **모든 백그라운드 작업에서도 보안 규칙이 일관되게 적용**되도록 보장합니다.
-   **확장성 및 유지보수:**
    -   **인터페이스 기반 설계:** `PaymentGateway`를 인터페이스로 추상화하여, 현재의 `MockPaymentGateway` 구현체를 향후 실제 PG사 연동 코드로 손쉽게 교체할 수 있도록 설계했습니다. 이로써 **결제 로직의 변경이 핵심 비즈니스 로직(`PaymentService`)에 영향을 주지 않도록** 했습니다.
    -   **도메인 분리:** `Membership`과 `Conversation` 로직이 명확히 분리되어 있어, 향후 새로운 멤버십 규칙을 추가하더라도 대화 기능에 미치는 영향을 최소화하고, 반대의 경우도 마찬가지입니다.

## **요구사항 분석 내용**
https://cyclic-basket-9b5.notion.site/Assignment-23640da4c42580b29426c097d1048fda
